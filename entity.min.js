/* Entity Game Engine | MIT License */
re=function(t){return"string"==typeof t?"#"==t[0]?re._t[t.slice(1)]:re._g[t]:new re.array(t)},re._c={},re._s={},re._g={},re._t={},re.ready=function(t){re.listener("load",t)},re.$=function(t){return re.$._[t]=re.$._[t]||("#"==t.charAt(0)?document.getElementById(t.substr(1)):document.getElementsByTagName(t)[0])},re.$._={},re.$new=function(t){return t?document.createElement(t):void 0},re.listener=function(t,e,i){(i||window).addEventListener(t,e,!0)},re.is=function(t,e){return 1==arguments.length?null!=t:null!=t&&Object.prototype.toString.call(t).slice(8,-1).toLowerCase()==e.toLowerCase()},re.extend=function(){var t={};for(var e in arguments)for(var i in arguments[e])t[i]=arguments[e][i];return t},re.base=function(){this._re_listens={}},re.base.extend=function(){var t=[].slice.call(arguments);return t.unshift(re.base.prototype),re.extend.apply(re,t)},re.base.extendArray=function(){var t=[],e=[].slice.call(arguments);e.unshift(re.base.prototype);for(var i in e)for(var s in e[i])t[s]=e[i][s];return t},re.base.prototype={tag:function(t){return null!=t?(re._t[this._tag]=null,re._t[this._tag=t]=this):this._tag},on:function(t,e,i,s){if(re.is(t,"object"))for(var r in t)this.on(r,t[r],e,i);else{if(this._re_listens[t]||(this._re_listens[t]=[]),!re.is(e))throw"Method is null";this._re_listens[t].push({c:i||this,f:e,o:s})}return this},once:function(t,e,i){return this.on(t,e,i,1)},off:function(t,e){if(re.is(t,"object"))for(var i in t)t.hasOwnProperty(i)&&this.off(i,t[i]);else if(e){var s=this._re_listens[t];for(var i in s)s[i].f==e&&s.splice(i,1)}else t?this._re_listens[t]=[]:this._re_listens={};return this},trigger:function(t){if(!this._re_listens[t])return this;for(var e,i=0,s=this._re_listens[t].length;s>i&&(e=this._re_listens[t],e);i++)e[i]&&(e[i].f.apply(e[i].c,Array.prototype.slice.call(arguments,1))===!1||e[i]&&e[i].o)&&e.splice(i,1);return this},attr:function(t,e){if(re.is(t,"object"))for(var i in t)this.set(i,t[i]);else this[t]=e;return this},set:function(t,e){if(re.is(t,"object"))for(var i in t)this.set(i,t[i]);else{var s="function";re.is(this[t],s)&&!re.is(e,s)?re.is(e,"array")?this[t].apply(this,e):this[t].call(this,e):this[t]=e}return this},get:function(t){return re.is(this[t],"function")?this[t]():this[t]},def:function(t,e){if(re.is(t,"object"))for(var i in t)this.def(i,t[i]);else re.is(this[t])||(this[t]=e);return this}},re.array=function(t){t&&this.push.apply(this,t)},re.array.prototype=re.base.extendArray({invoke:function(t){var e=[].slice.call(arguments,1);return this.each(function(i){i[t].apply(i,e)})},each:function(t,e){for(var i,s=this.length,r=-1;s>++r&&null!=(i=this[r])&&t.call(e||this,i,r,this)!==!1;);return this},sample:function(){return this[0|Math.random()*this.length]},pluck:function(t){var e=[],i=t.split(" ");return this.each(function(t){var s={};for(var r in i){var n=i[r];s[n]=t[n]}e.push(s)}),e},isEmpty:function(){return!this.length},find:function(t,e){for(var i=0,s=this.length;s>i;i++)if(t.call(e||this,this[i],i,this))return this[i];return null},findAll:function(t,e){for(var i=new re.array,s=0,r=this.length;r>s;s++)t.call(e||this,this[s],s,this)&&i.push(this[s]);return i},min:function(t,e){var i,s=1/0;return this.each(function(r,n,o){var h=t.call(e||this,r,n,o);s>h&&(s=h,i=r)}),i},max:function(t,e){var i,s=-1/0;return this.each(function(r,n,o){var h=t.call(e||this,r,n,o);h>s&&(s=h,i=r)}),i},sum:function(t,e){var i=0;return this.each(function(s,r,n){i+=t.call(e||this,s,r,n)}),i},filter:function(){return re(Array.prototype.filter.apply(this,arguments))},reject:function(t,e){for(var i=0;this.length>i;i++)t.call(e||this,this[i],i,this)&&this.splice(i,1);return this},clear:function(){return this.length=0,this},disposeAll:function(){var t=this.slice();for(var e in t)t[e].dispose();return this},count:function(t,e){return this.findAll(t,e).length},clone:function(){return this.slice()},contains:function(t){return!!~this.indexOf(t)},remove:function(t){for(var e=0;this.length>e;e++)this[e]==t&&this.splice(e,1);return this},removeAt:function(t,e){e||(e=t);for(var i=0;e-t>=i;i++)this.splice(t,1);return this},addAfter:function(t,e){return this.splice(this.indexOf(t)+1,0,e),this},addBefore:function(t,e){return this.splice(this.indexOf(t),0,e),this},swap:function(t,e){var i=this.indexOf(t),s=this.indexOf(e),r=this[i];return this[i]=e,this[s]=r,this},first:function(t){return t?this.slice(0,t):this[0]},last:function(t){if(!t)return this[this.length-1];var e=0>this.length-t?0:this.length-t;return this.slice(e)}}),re.comp=re.c=function(t,e){if(re._c[t]||(re._c[t]=new re.c.init(t)),e)for(var i in e)re._c[t][i](e[i]);return re._c[t]},re.c.init=function(t){if(this.name=t,this._re_defaults={},this._re_defines={},this._re_events={},this._re_setters={},this._re_getters={},!re[this.name]){var e=this;re[this.name]=function(){return e._re_method.apply(e,arguments)}}},re.c.init.prototype={z:function(t,e){return this[t]||(this[t]=[]),this[t]=re.is(e,"string")?this[t].concat(e.split(" ")):this[t].concat(e),this},singleton:function(t){return this._re_method=function(){return this._singleton||(this._singleton=re.e(t||this.name))},this},accessors:function(t){re.is(t,"string")&&(t=t.split(" "));var e;for(var i in t)e="_"+t[i],this.getters(t[i],Function("return this."+e+";")),this.setters(t[i],Function("v","this."+e+" = v;"))},getters:function(t,e){if(e)this._re_getters[t]=e;else for(var i in t)this._re_getters[i]=t[i];return this},setters:function(t,e){if(e)this._re_setters[t]=e;else for(var i in t)this._re_setters[i]=t[i];return this},statics:function(t,e){if(re.is(e))re[this.name][t]=e;else for(var i in t)re[this.name][i]=t[i];return this},events:function(t,e){if(re.is(e))this._re_events[t]=e;else for(var i in t)this._re_events[i]=t[i];return this},factory:function(t){return this._re_factory=t,this},_re_method:function(){var t=re.e(this.name),e=this._re_factory;return e?e.apply(t,arguments):t.set.apply(t,arguments),t},method:function(t){return this._re_method=t.bind(re[this.name]),this},requires:function(t){return this.z("_re_requires",t)},alias:function(t){var e=t.split(" ");if(e.length>1){for(var i in e)this.alias(e[i]);return this}return"-"==t.charAt(0)?re._c[t.substr(1)]==this&&delete re._c[t.substr(1)]:re._c[t]=this,this},defaults:function(t,e){if(1==arguments.length)for(var i in t)this._re_defaults[i]=t[i];else this._re_defaults[t]=e;return this},namespaces:function(t,e){var i=this.name+"_";if(1==arguments.length)for(var s in t)this._re_defines[i+s]=t[s];else this._re_defines[i+t]=e;return this},defines:function(t,e){if(1==arguments.length)for(var i in t)this._re_defines[i]=t[i];else this._re_defines[t]=e;return this},init:function(t){return this._re_init=t,this},dispose:function(t){return this._re_dispose=t,this},run:function(t){return t.call(this),this}},function(t){var e=function(e){return new t.entity.init(e)},i=function(t){this._re_comps=[],this._re_listens={},this.comp(t)},s=i.prototype=t.base.extend({});s.comp=function(e){if(!e)return this;var i;i=t.is(e,"array")?e:e.split(" ");for(var s=0;i.length>s;s++){if(e=i[s],!e)return this;if(!this.has(e)){var r,n=t._c[e];if(this._re_comps.push(e),n){this.comp(n._re_requires);for(r in n._re_setters)this.__defineSetter__(r,n._re_setters[r]);for(r in n._re_getters)this.__defineGetter__(r,n._re_getters[r]);n._re_defaults&&this.def(n._re_defaults),n._re_defines&&this.set(n._re_defines),n._re_events&&this.set(n._re_events).on(n._re_events),n._re_init&&n._re_init.call(this)}t._g[e]&&t._g[e].add(this)}}return this},s.removeComp=function(e){var i;if(i=t.is(e,"array")?e:e.split(" "),i.length>1){for(var s;s=i.shift();)this.removeComp(s);return this}if(e=i[0],e&&this.has(e)){var r=t._c[e];r&&r._re_dispose&&r._re_dispose.call(this,r),t._g[e]&&t._g[e].remove(this),this._re_comps.splice(this._re_comps.indexOf(e),1)}return this},s.comps=function(){return this._re_comps.slice()},s.clone=function(){return t.e(this._re_comps)},s._super=function(e,i){var s=Array.prototype.slice.call(arguments,2);if(""==e)return t.e.init.prototype[i].apply(this,s);var r=t._c[e];return r._re_defines[i]?r._re_defines[i].apply(this,s):r._re_defaults[i].apply(this,s)},s.has=function(e){for(t.is(e,"string")&&(e=e.split(" ")),s=0;e.length>s;s++)if(!~this._re_comps.indexOf(e[s]))return!1;return!0},s.dispose=function(){return this.removeComp(this.comps()),this.trigger("dispose"),this.off()},t.entity=t.e=e,t.entity.init=i}(re),re.group=re.g=function(t){return re.g._g[t]||(re.g._g[t]=new re.g.init(t)),re.g._g[t]},re.g._g={},re.g.init=function(t){this.name=t,this._requires=[],this._defines={};var e=this;this._init=function(t){t&&this.push.apply(this,t)},this._group=function(t){this.name=t,re.base.call(this);for(var i in e._requires){var s=re.g(e._requires[i]);this.def(s._defines)}},this._group.prototype=re.base.extendArray(re.array.prototype,{dispose:function(){return re._g[this.name]=null,this.each(function(t){t.dispose&&t.dispose()})},add:function(t){return this.push(t),this.trigger("add",t)},remove:function(t){return re.array.prototype.remove.call(this,t),this.trigger("remove",t)}})},re.g.init.prototype={requires:function(t){return re.is(t,"string")&&(t=t.split(" ")),this._requires=this._requires.concat(t),this},defines:function(t){for(var e in t)this._group.prototype[e]=t[e],this._defines[e]=t[e];return this},init:function(t){return this._init=t,this},create:function(){var t=new this._group(this.name);return re._g[t.name]=t,this._init.apply(t,arguments),t},_super:function(){return this._group.prototype}},function(t){var e=function(e){return new t.load.init(e)};e.path="",e.file=function(t){return t.split("/").pop().split("?").shift()},e.imageExt="img",e.soundExt="sfx",e.images=["gif","jpg","jpeg","png"],e.sounds=["wav","mp3","aac","ogg"];var i=function(e){if(t.is(e,"string"))this.assets=e.split(" ");else if(t.is(e,"object")){this.assets=[];for(var i in e)t.is(e[i],"array")&&(this.assets=this.assets.concat(e[i]))}else this.assets=e;for(var s,i=0;this.assets.length>i;i++){this.total++,s=this.assets[i];var r=s.match(/^(\/|http:)/)?s:t.load.path+s;s=t.load.file(s);var n=s.lastIndexOf(".")+1,o=s.substr(n).toLowerCase(),h=s.substr(0,n);if(-1!=t.load.images.indexOf(o))this._loadImg(r,s,h);else if(-1!=t.load.sounds.indexOf(o)){if(!(window.soundManager&&"mp3"==o||t.support(o))){this.total--;continue}if(t._c[h+t.load.soundExt]){this.total--;continue}this._loadSound(r,s,h)}}return this},s=i.prototype;s.current=0,s.total=0,s._loadImg=function(e,i,s){var r=this,n=new Image;return t.c(i).alias(s+t.load.imageExt).defines({_image:n}).image=n,n.onload=function(){t.c(i).defines({sizeX:n.width,sizeY:n.height,bisect:n.width}),r._loaded()},n.crossOrigin="",n.onerror=function(){r._e&&r._e.call(r,i)},n.src=e,this},s._loaded=function(){this.current++,this.current<=this.total&&this._p&&this._p(this.current,this.total,this.assets[this.current-1]),this.current==this.total&&this._s&&this._s(this.assets)},s._loadSound=function(t,e,i){var s,r=this;if(window.soundManager)soundManager.onready(function(){s=soundManager.createSound({id:e,url:t,autoLoad:!0,onload:function(){r._loaded()}}),r._def_sfx(s,e,i)});else{s=new Audio,s.preload="auto",s.load();var n=function(){r._loaded(),s.removeEventListener("canplaythrough",n)};s.addEventListener("canplaythrough",n,!1),s.addEventListener("error",function(){r._e&&r._e.call(r,e)},!1),s.src=t,this._def_sfx(s,e,i)}},s._def_sfx=function(e,i,s){t.c(i).alias(s+t.load.soundExt).defines({_sound:e}).sound=e},s.progress=function(t){return this._p=t,this},s.complete=function(t){return this._s=t,this.assets.length||t([]),this},s.error=function(t){return this._e=t,this},t.load=e,t.load.init=i}(re),re.c("loop").singleton().defaults({clearColor:"#f9f9f9",stepSize:.03,maxTick:.05,running:!1,sizeX:10,sizeY:10}).defines({clear:function(t){return t?(this.context.fillStyle=t,this.context.fillRect(0,0,this.sizeX,this.sizeY)):this.context.clearRect(0,0,this.sizeX,this.sizeY),this},start:function(){if(!this.running){this.running=!0;var t,e=this;(t=function(){e.loop(),e.running&&e.requestAnimationFrame(t,e.canvas)})()}return this},stop:function(){return this.running=!1,this},init:function(t,e){this.comp("polyfill tick timestep"),this.canvas=re.is(t,"htmlcanvaselement")?t:re.$(t),this.context=this.canvas.getContext(e||"2d");var i=re.screen();return this.sizeX=i.sizeX=this.canvas.width,this.sizeY=i.sizeY=this.canvas.height,this.second=30*this.stepSize,this.initSystems(),this},initSystems:function(){this.keyboardSys=re.s("keyboard").create(),this.mouseSys=re.s("mouse").create(this.canvas),this.renderSys=re.s("render").create(this.context),this.updateSys=re.s("update").create()},loop:function(){this.timestep(Math.min(this.tick()/1e3,this.maxTick),function(){this.update()}),this.draw()},update:function(){this.updateSys.processAll()},draw:function(){this.clear(this.clearColor),this.renderSys.processAll()}}),re.system=re.s=function(t){return re._s[t]||(re._s[t]=new re.s.init(t)),re._s[t]},re.s.init=function(t){this.name=t,this._requires=[],this._defines={};var e=this;this._init=function(t){this.entities=t},this._system=function(){re.base.call(this);for(var t in e._requires){var i=re.s(e._requires[t]);this.def(i._defines)}e._init.apply(this,arguments)},this._system.prototype=re.base.extend({processAll:function(){if(this.canProcess.apply(this,arguments)){var t=[].slice.call(arguments);t.unshift(0);for(var e=0;this.entities.length>e;e++)t[0]=this.entities[e],this.process.apply(this,t)}return this},canProcess:function(){return this.entities.length},dispose:function(){this.entities.dispose&&this.entities.dispose(),this.entities=null}})},re.s.init.prototype={requires:function(t){return re.is(t,"string")&&(t=t.split(" ")),this._requires=this._requires.concat(t),this},defines:function(t){for(var e in t)this._system.prototype[e]=t[e],this._defines[e]=t[e];return this},init:function(t){return this._init=t,this},create:function(t,e,i){return new this._system(t,e,i)},_super:function(){return this._system.prototype}},re.c("tick").init(function(){this.lastTime=Date.now()}).defines({tick:function(){var t=Date.now(),e=this.lastTime;return this.lastTime=t,t-e}}),re.c("tween").requires("update").namespaces({update:function(t){if(this.tweening){this.tween_time+=t;var e=this.tween_time/this.tween_t;e>1&&(e=1),value=this.tweenEase(e);for(var i in this.tween_d){var s=this.tween_s[i]+this.tween_d[i]*value;this.set(i,s)}this.trigger("tween:update",value),1==e&&(this.tweening=!1,this.off("update",this.tween_update),this.trigger("tween:finish"))}}}).defaults({tweening:!1,tweenEase:function(t){return t}}).defines({tween:function(t,e){t>=100&&(t/=1e3);var i=(t||1)/re.loop().second;this.tween_time=0;var s={},r={};for(var n in e){var o=this.get(n);s[n]=e[n]-o,r[n]=o}return this.tween_s=r,this.tween_d=s,this.tween_t=i,this.tweening||this.on("update",this.tween_update),this.tweening=!0,this.trigger("tween:start",r)}}),re.tween=function(t,e,i){return t.comp("tween").tween(e,i)},re.c("update").defaults({updatable:!0}),re.c("align").defaults({regX:0,regY:0,sizeX:1,sizeY:1,posX:0,posY:0}).defines({align:function(t,e){return this.alignHor(t),this.alignVer(e)},alignHor:function(t){return t=t||0,this.set("posX",0|.5*re.loop().sizeX-.5*(this.get("sizeX")-this.get("regX"))+t),this},alignVer:function(t){return t=t||0,this.set("posY",0|.5*re.loop().sizeY-.5*(this.get("sizeY")-this.get("regY"))+t),this},alignRight:function(t){return t=t||0,this.set("posX",0|re.loop().sizeX-(this.get("sizeX")-this.get("regX"))+t),this},alignLeft:function(t){t=t||0;var e=this.get("sizeX");return this.set("posX",0|t+e-(e-this.get("regX"))),this},alignTop:function(t){t=t||0;var e=this.get("sizeY");return this.set("posY",0|t+e-(e-this.get("regY"))),this},alignBottom:function(t){return t=t||0,this.set("posY",0|re.loop().sizeY-(this.get("sizeY")-this.get("regY"))+t),this}}),re.c("animate").requires("flicker").defines({flicker_stop:function(){this._super("flicker","flicker_stop"),this.animate_finish&&this.animate_finish()},animate:function(t,e,i){if(this.flickering()!=t){this.animate_finish=e,this.animate_update=i;var s=this.animates[t];this.flicker(s[0],s[1],s[2],t),s.push&&this.flicker_run()}return this},animating:function(t){return this.flickering(t)},flick:function(t){this.frame(t),this.animate_update&&this.animate_update.apply(this,arguments)}}),re.c("circle").requires("draw").defaults({color:"#82d5f4"}).defines({draw:function(t){t.fillStyle=this.color,t.beginPath();var e=this.get("radius");return t.arc(-this.regX+e,-this.regY+e,e,0,2*Math.PI,!0),t.closePath(),t.fill(),this},radius:function(t){return re.is(t)?(this.sizeX=this.sizeY=2*t,this):.5*this.sizeX}}),re.c("draw").defaults({screenable:!0,drawable:!0,rotation:0,alpha:1,scaleX:1,scaleY:1,posX:0,posY:0,sizeX:10,sizeY:10,regX:0,regY:0}).defines({screenX:function(t){return t?(this.posX=t+re.screen().posX,this):this.posX-re.screen().posX},screenY:function(t){return t?(this.posY=t+re.screen().posY,this):this.posY-re.screen().posY},visible:function(){return this.drawable&&re.screen().hit(this.posX,this.posY,this.sizeX,this.sizeY,this.regX,this.regY)}}),re.c("el").requires("align").defines({posX:function(t){return re.is(t)?(this.$el.css("left",t),this):this.$el.position().left},posY:function(t){return re.is(t)?(this.$el.css("top",t),this):this.$el.position().top},sizeX:function(){return this.$el.outerWidth()},sizeY:function(){return this.$el.outerHeight()},click:function(t){var e=this;return this.$el.click(function(i){t.call(e,i)}),this},$:function(t,e){return this.$el.find(t,e)},setEl:function(t){return this.removeEl(),re.is(t,"string")&&(t=re.$new(t)),this.el=t,this.$el=$(t).addClass("el"),this.posX(0),this.posY(0),this},text:function(t){return re.is(t)?(this.$el.text(t),this):this.$el.text()},addEl:function(t){return t=t||$(re.loop().canvas).parent(),t.append(this.el),this},removeEl:function(){return this.$el&&this.$el.remove(),this},hide:function(){return this.$el.hide(),this},show:function(){return this.$el.show(),this}}).init(function(){this.setEl("div")}).dispose(function(){this.removeEl()}),re.c("image").requires("draw").defines({image:function(t){return re.is(t)?(this.set({_image:t,sizeX:t.width,sizeY:t.height,bisect:t.width}),this):this._image},visible:function(){return this._image&&this._super("draw","visible")},draw:function(t){return t.drawImage(this._image,-this.regX,-this.regY,this.sizeX,this.sizeY),this}}).init(function(){this._image&&this.image(this._image)}),re.c("imgtext").requires("draw").defaults({charOffset:32,lineHeight:15}).defines({visible:function(){return this._text&&this._image&&this._super("draw","visible")},draw:function(t){for(var e=0;this.text_lines.length>e;e++)this.drawText(t,this.text_lines[e],e*this.lineHeight);return this},drawText:function(t,e,i){for(var s,r,n,o=0,h=0,a=e.length;a>h;++h){if(r=e.charCodeAt(h)-this.charOffset,s=this.imgtext[r],!this.charCache[r]){n=0;for(var u=0;r>u;++u)n+=this.imgtext[u]+1;this.charCache[r]=n}t.drawImage(this._image,this.charCache[r],0,s,this._image.height,-this.regX+o,-this.regY+i,s,this._image.height),o+=s}},text:function(t){if(re.is(t)){this._text=t,this.text_lines=this._text.split("\n"),this.sizeX=0;for(var e in this.text_lines){for(var i=0,s=0;this.text_lines[e].length>s;s++)i+=this.imgtext[s];i>this.sizeX&&(this.sizeX=i)}return this.sizeY=this.text_lines.length*this.lineHeight,this}return this._text}}).init(function(){this.charCache||(this.charCache={}),this.text("")}),re.c("rect").requires("draw").defaults({color:"#82d5f4"}).defines({draw:function(t){return t.fillStyle=this.color,t.fillRect(-this.regX,-this.regY,this.sizeX,this.sizeY),this}}),re.c("screen").singleton().requires("hit").defines({pos:function(t,e){return arguments.length?(re.is(t,"object")&&(e=t.posY,t=t.posX),this.posX=t-this.regX-this.offX,this.posY=e-this.regY-this.offY,this):this},toScreenX:function(t){return t+this.posX-this.offX-this.regX},toScreenY:function(t){return t+this.posY-this.offY-this.regY}}).defaults({posX:0,posY:0,regX:0,regY:0,sizeX:0,sizeY:0,offX:0,offY:0}),re.c("sprite").requires("image bisect").defaults({frameX:0,frameY:0}).defines({frame:function(t){return re.is(t)?(this.frameX=this.biToTileX(t),this.frameY=this.biToTileY(t),this):this.tileToBi(this.frameX,this.frameY)},draw:function(t){return t.drawImage(this._image,this.frameX*this.sizeX,this.frameY*this.sizeY,this.sizeX,this.sizeY,-this.regX,-this.regY,this.sizeX,this.sizeY),this}}),re.c("text").requires("draw").defaults({font:"14px sans-serif",textColor:"#000000",textAlign:"left",textBaseline:"top",lineHeight:15}).defines({visible:function(){return this._text&&this._super("draw","visible")},text:function(t){if(re.is(t)){if(t=Array.prototype.join.call(arguments," "),this.text_lines=t.split("\n"),this._text=t,re.loop().context){var e=re.loop().context;e.save(),e.font=this.font,this.sizeX=0;var i=0;for(var s in this.text_lines)i=e.measureText(this.text_lines[s]).width,i>this.sizeX&&(this.sizeX=i);e.restore()}return this.sizeY=this.text_lines.length*this.lineHeight,this}return this._text},draw:function(t){t.font=this.font,t.fillStyle=this.textColor,t.textAlign=this.textAlign,t.textBaseline=this.textBaseline;for(var e=this.text_lines,i=0,s=e.length;s>i;i++)t.fillText(e[i],-this.regX,-this.regY+i*this.lineHeight);return this}}),re.s("keyboard").defines({focusStop:!0,keyCodes:{65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",16:"shift",17:"ctrl",18:"alt",24:"cmd",255:"fn",8:"backspace",13:"enter",32:"space",27:"esc",9:"tab",20:"capslock",91:"windows",46:"delete",36:"home",35:"end",33:"pageup",34:"pagedown",37:"left",38:"up",39:"right",40:"down",96:"`",45:"-",187:"=",219:"[",221:"]",220:"\\",59:";",222:"'",188:",",190:".",191:"/"},event:function(t){var e=(t.target||t.srcElement||{}).tagName;if(!(this.focusStop&&e&&e.match(/INPUT|SELECT|TEXTAREA/))){var i=t.keyCode||t.which,s=this.keyCodes[i];return this.key(s,t.type,t)}},key:function(t,e,i){re.pressed&&re.pressed.d&&(re.pressed.d[t]="keydown"==e),re.preventDefault&&re.preventDefault.d[t]&&i.preventDefault();for(var s=0;this.entities.length>s;s++)this.entities[s].trigger(e,t,i).trigger(e+":"+t,t,i);return this}}).init(function(){this.entities=re.g("keyboard").create(),re.listener("keydown",this.event.bind(this)),re.listener("keyup",this.event.bind(this)),re.listener("focus",function(){re.pressed.d={}})}),re.s("mouse").defines({press:function(t){var e,i;e=null==t.which?2>t.button?"left":4==t.button?"middle":"right":2>t.which?"left":2==t.which?"middle":"right",i="mouse:"+e,this.event(t,i)},event:function(t,e){var i=this.canvas,s=i.width/i.offsetWidth,r=i.height/i.offsetHeight;return null!=t.offsetX?(s*=t.offsetX,r*=t.offsetY):(s*=t.layerX-i.offsetLeft,r*=t.layerY-i.offsetTop),this.mouse(s,r,t.type,e,t)},mouse:function(t,e,i,s,r){return re.pressed&&re.pressed.d&&(re.pressed.d["mouse:"+s]="mousedown"==i),this.processAll(t,e,i,s,r)},processX:function(t,e){return e+this.offX},processY:function(t,e){return e+this.offY},process:function(t,e,i,s,r,n){e=this.processX(t,e),i=this.processY(t,i),t.trigger(s,e,i,t),r&&t.trigger(s+":"+r,e,i,n)},bindEvents:function(t){this.canvas=t;var e=this.event.bind(this),i=this.press.bind(this);re.listener("mousedown",i,t),re.listener("mouseup",i,t),re.listener("mousemove",e,t),re.listener("mouseover",e,t),re.listener("mouseout",e,t),re.listener("click",e,t),re.listener("dblclick",e,t),re.listener("contextmenu",e,t)},offX:0,offY:0}).init(function(t){this.entities=re.g("mouse").create(),this.bindEvents(t)}),re.pressed=function(t){var e=arguments;re.is(t,"array")&&(e=t);for(var i=0,s=e.length;s>i;i++)if(re.pressed.d[e[i]])return!0;return!1},re.pressed.d={},re.preventDefault=function(t){re.is(t,"string")&&(t=t.split(" "));for(var e in t)re.preventDefault.d[t[e]]=1},re.preventDefault.d={},re.c("bisect").statics({toX:function(t,e,i){return this.toTileX(t,e,i)*i},toY:function(t,e,i,s){return this.toTileY(t,e,i)*s},toTileX:function(t,e,i){return 0|t%(e/i)},toTileY:function(t,e,i){return 0|t*i/(e-.1)},tileToBi:function(t,e,i,s){return t+e*(i/s)}}).defines({biToX:function(t){return re.bisect.toX(t,this.bisect,this.sizeX)},biToY:function(t){return re.bisect.toY(t,this.bisect,this.sizeX,this.sizeY)},biToTileX:function(t){return re.bisect.toTileX(t,this.bisect,this.sizeX)},biToTileY:function(t){return re.bisect.toTileY(t,this.bisect,this.sizeX)},tileToBi:function(t,e){return re.bisect.tileToBi(t,e,this.bisect,this.sizeX)}}).defaults({bisect:1,sizeX:1,sizeY:1}),re.c("body").defines({hit:function(t,e,i,s,r,n){re.is(t,"object")&&(e=t.posY||t.y,i=t.sizeX||t.w,s=t.sizeY||t.h,r=t.regX||0,n=t.regY||0,t=t.posX||t.x),r=r||0,n=n||0;var o=this.regX||0,h=this.regY||0;return!(t-r>this.posX+this.bodyX-this.padX-o||this.posX+this.padX-o>t+i-r||e-n>this.posY+this.bodyY-this.padY-h||this.posY+this.padY-h>e+s-n)},hitBody:function(t,e,i,s,r,n,o,h){re.is(t,"object")&&(e=t.posY||t.y,i=t.bodyX,s=t.bodyY,r=t.padX,n=t.padY,o=t.regX||0,h=t.regY||0,t=t.posX||t.x),o=o||0,h=h||0;var a=this.regX||0,u=this.regY||0;return!(t+r-o>this.posX+this.bodyX+this.padX-a||this.posX+this.padX-a>t+i-r-o||e+n-h>this.posY+this.bodyY-this.padY-u||this.posY+this.padY-u>e+s-n-h)}}).defaults({posX:0,posY:0,padX:0,padY:0,bodyX:1,bodyY:1}),re.c("clamp").method(function(t,e,i){return e>t?e:null!=i&&t>i?i:t}).defines("clamp",function(t){var e=Array.prototype.slice.apply(arguments);return e[0]=this.get(t),this.set(t,re.clamp.apply(re,e)),this}),re.distance=function(t,e,i,s){var r,n;return r=i-t,n=s-e,Math.sqrt(r*r+n*n)},re.c("drag").defaults({posX:0,posY:0,dragX:0,dragY:0,dragging:!1}).defines({dragStart:function(t,e){return this.dragging||(this.dragging=!0,this.dragX=t,this.dragY=e,this.trigger("drag:start")),this},dragFinish:function(){return this.dragging=!1,this.trigger("drag:finish")},dragUpdate:function(t,e){return this.dragging&&(this.posX+=t-this.dragX,this.posY+=e-this.dragY,this.dragX=t,this.dragY=e,this.trigger("drag:update")),this}}),re.c("force").requires("update").statics({graX:0,graY:0}).defaults({posX:0,posY:0,velX:0,velY:0,friX:.4,friY:.4,accX:0,accY:0,resX:.4,resY:.4,mass:1}).namespaces({update:function(){this.velX=this.force(this.velX,this.accX,this.friX,this.graX,this.mass),this.velY=this.force(this.velY,this.accY,this.friY,this.graY,this.mass),this.hitmap?this.aftermath(this.hitmap.checkHit(this)):this.aftermath(this.posX+this.velX,this.posY+this.velY)}}).defines({aftermath:function(t,e,i,s,r,n){return re.is(t,"object")&&(i=t.hitX,s=t.hitY,r=t.tarX,n=t.tarY,e=t.posY,t=t.posX),this.posX=t,this.posY=e,i&&(this.velX=this.forceRes(this.velX,this.resX)),s&&(this.velY=this.forceRes(this.velY,this.resY)),this.trigger("aftermath",i,s,r,n)},forceRes:function(t,e){return t*-e},forceGra:function(t,e){return t*e},forceVel:function(t,e,i){return(t+e)*i},force:function(t,e,i,s,r){var n=this.forceVel(t,e,i)+this.forceGra(s,r);return.01>Math.abs(n)&&(n=0),n},isIdle:function(t){return t=t||0,t>=Math.abs(this.velY+this.velX+this.accX+this.accY)}}).init(function(){this.def({hitmap:re.hitmap,graX:re.force.graX,graY:re.force.graY}),this.on("update",this.force_update)}).dispose(function(){this.off("update",this.force_update)}),re.c("hit").defaults({posX:0,posY:0,sizeX:1,sizeY:1,hit:function(t,e,i,s,r,n){re.is(t,"object")&&(e=t.posY||t.y,i=t.sizeX||t.w,s=t.sizeY||t.h,r=t.regX||0,n=t.regY||0,t=t.posX||t.x),r=r||0,n=n||0;var o=this.regX||0,h=this.regY||0;return!(t-r>this.posX+this.sizeX-o||this.posX-o>t+i-r||e-n>this.posY+this.sizeY-h||this.posY-h>e+s-n)}}),re.c("hitmap").requires("automap").defines({hitValue:1,checkAxisX:function(t){return t==this.hitValue},checkAxisY:function(t){return t==this.hitValue},checkHit:function(t,e,i,s,r,n,o,h){re.is(t,"object")&&(i=t.velX,s=t.velY,r=t.bodyX||t.sizeX,n=t.bodyY||t.sizeY,o=t.padX||0,h=t.padY||0,e=t.posY,t=t.posX);var a={posX:t,posY:e},u=0|Math.max(Math.abs(i),Math.abs(s))/(.5*(re.tile.sizeX+re.tile.sizeY))+.5;if(u>1)for(var c=i/u,f=s/u,l=0;u>l&&(c||f);l++)this.hitmap_step(a,t,e,c,f,r,n,h,h),a.hitX&&(c=0),a.hitY&&(f=0);else this.hitmap_step(a,t,e,i,s,r,n,o,h);return a}}).namespaces({step:function(t,e,i,s,r,n,o,h,a){t.posX+=s,t.posY+=r;var u,c,f;if(s){u=re.tile.sizeX;var l=s>0?n-h:h,p=Math.floor((i+a)/u),d=Math.ceil((i+o-a)/u);f=Math.floor((e+s+l)/u);var g=0>s?u:0;if(f>=0&&this.lenX>f&&d>=0&&this.lenY>p)for(c=p;d>c;c++)if(this._automap[c]&&(this.trigger("hit",this._automap[c][f],f,c),this.checkAxisX(this._automap[c][f],e,i,s,r))){t.hitX=!0,t.posX=f*u+g-l,t.tarX=f*u,t.tarY=c*u;break}}if(r){u=re.tile.sizeY;var _=r>0?o-a:a,m=Math.floor((t.posX+h)/u),v=Math.ceil((t.posX+n-h)/u);c=Math.floor((i+r+_)/u);var X=0>r?u:0;if(c>=0&&this.lenY>c&&v>=0&&this.lenX>m)for(f=m;v>f;f++)if(this._automap[c]&&(this.trigger("hit",this._automap[c][f],f,c),this.checkAxisY(this._automap[c][f],e,i,s,r))){t.hitY=!0,t.posY=c*u+X-_,t.tarX=f*u,t.tarY=c*u;break}}}}),re.hitmap=null,re.c("iso").statics({sizeX:30,sizeY:30,sizeZ:30,toPosX:function(t,e){var i=this.toIsoX(t,e),s=this.toIsoY(t,e);return(i-s)*this.sizeX},toPosY:function(t,e){var i=this.toIsoX(t,e),s=this.toIsoY(t,e);return.5*(i+s)*this.sizeY},toPos:function(t,e){return re.is(t,"object")&&(e=t.posY||t.y,t=t.posX||t.x),{posX:this.toPosX(t,e),posY:this.toPosY(t,e)}},toIsoX:function(t,e){var i=.5*(2*e-t),s=t+i;return Math.round(s/this.sizeX)-1},toIsoY:function(t,e){var i=.5*(2*e-t);return Math.round(i/this.sizeY)},toIso:function(t,e){return re.is(t,"object")&&(e=t.posY||t.y,t=t.posX||t.x),{isoX:this.toIsoX(t,e),isoY:this.toIsoY(t,e)}}}).defaults({posX:0,posY:0,posZ:0}).defines({iso:function(t,e,i){if(re.is(t,"object")){if(i=t.z,re.is(t.posZ)&&(i=t.posZ/re.iso.sizeZ),e=t.y,re.is(t.posX)&&re.is(t.posY))return this.posX=t.posX,this.posY=t.posY,t.posZ&&(this.posZ=t.posZ),this;t=t.x}return t=re.is(t)?t:this.isoX(),t*=re.iso.sizeX,e=re.is(e)?e:this.isoY(),e*=re.iso.sizeY,i=re.is(i)?i:this.isoZ(),i*=re.iso.sizeZ,this.posX=t-e,this.posY=.5*(t+e)-i,this.posZ=i,this},isoX:function(t){return re.is(t)?this.iso(t):(this.posX+.5*(2*(this.posY+this.posZ)-this.posX))/re.iso.sizeX},isoY:function(t){return re.is(t)?this.iso({y:t}):.5*(2*(this.posY+this.posZ)-this.posX)/re.iso.sizeY},isoZ:function(t){return re.is(t)?this.iso({z:t}):this.posZ/re.iso.sizeZ},onIso:function(){var t=this.isoX()+this.isoY()+this.isoZ();return(0|t)==t}}),re.c("point").defaults({posX:0,posY:0}).defines({pos:function(t,e){return re.is(t,"object")&&(e=t.posY||t.y,t=t.posX||t.x),this.posX=t,this.posY=e,this},distance:function(t,e){return re.is(t,"object")&&(e=t.posY||t.y,t=t.posX||t.x),re.distance(this.posX,this.posY,t,e)}}),re.random=function(t,e){var i=Math.random();if(re.is(t,"array"))return t[0|i*t.length];if(re.is(t,"object")){var s;for(var r in t)(Math.random()<1/++i||!re.is(s))&&(s=r);return s}switch(arguments.length){case 0:return i;case 1:return i*t;case 2:return i*(t-e)+e}},re.randomInt=function(){return 0|re.random.apply(this,arguments)},re.range=function(t,e,i){for(var s=[],r=t||0;e>r;r+=i||1)s.push(r);return s},re.c("tile").statics({sizeX:40,sizeY:40,toPosX:function(t){return this.toTileX(t)*this.sizeX},toPosY:function(t){return this.toTileY(t)*this.sizeY},toPos:function(t,e){return re.is(t,"object")&&(e=t.posY||t.y,t=t.posX||t.x),{posX:this.toPosX(t),posY:this.toPosY(e)}},toTileX:function(t){return 0|(t-.5*this.sizeX)/this.sizeX+.5},toTileY:function(t){return 0|(t-.5*this.sizeY)/this.sizeY+.5},toTile:function(t,e){return re.is(t,"object")&&(e=t.posY||t.y,t=t.posX||t.x),{tileX:this.toTileX(t),tileY:this.toTileY(e)}}}).defaults({posX:0,posY:0,regX:0,regY:0}).defines({tile:function(t,e){return re.is(t,"object")&&(e=t.y||re.tile.toTileY(t.posY),t=t.x||re.tile.toTileX(t.posX)),this.tileX(t),this.tileY(e),this},atTile:function(t,e){return this.tileX()==t&&this.tileY()==e},tileX:function(t){return re.is(t)?(this.posX=0|t*this.sizeX+.5,this):0|this.posX/this.sizeX+.5},tileY:function(t){return re.is(t)?(this.posY=0|t*this.sizeY+.5,this):0|this.posY/this.sizeY+.5
}}).init(function(){this.sizeX=re.tile.sizeX,this.sizeY=re.tile.sizeY}),re.c("playlist"),re.c("sound").statics({enabled:!0,volume:1}).defaults({playing:!1}).namespaces({e:0,ended:function(){this.playing=0,this.trigger("sound:finish")}}).defines({play:function(t,e,i){if(!this._sound||!re.sound.enabled)return this;this.playing&&this.stop();var s=this._sound,r=this;if(e=e||re.sound.volume,window.soundManager)s.play({onfinish:function(){r.sound_ended(),i&&i(r)},position:0,volume:e,loops:t||1});else{s.currentTime=0,s.volume=e,t=t||1;var n=function(){--t>0?s.play():(s.removeEventListener("ended",n),r.sound_ended(),i&&i(r))};s.addEventListener("ended",n),s.play()}return this.playing=1,this},stop:function(){return this._sound.pause(),this.playing=0,this}}),re.c("automap").defaults({lenX:0,lenY:0,automapDefault:0}).defines({automap:function(t,e,i){if(re.is(t,"array")){if(e)for(var e=0;t.length>e;e++)for(var s=0;t[0].length>s;s++)this.automap(s,e,t[e][s]);else this._automap=t,this.lenX=t.length>0?t[0].length:0,this.lenY=t.length;return this}if(!re.is(i))return this.within(t,e)?this._automap[e][t]:null;for(;e>=this._automap.length;){var r=Array(this._automap[0]);for(var n in r)r[n]=this.automapDefault;this._automap.push(r)}for(;t>=this._automap[this._automap.length-1].length;)for(var s=0;this._automap.length>s;s++)t>=this._automap[s].length&&this._automap[s].push(this.automapDefault);return this.lenX=this._automap[e].length,this.lenY=this._automap.length,this._automap[e][t]=i,this},within:function(t,e){return e>=0&&this.lenY>e&&t>=0&&this.lenX>t}}).init(function(){this._automap=[]}),re.c("flicker").requires("update timestep").namespaces({flickering:"",stop:function(){var t=this.flicker_id;return this.flicker_id="",this.stepProgress=0,this.off("update",this.flicker_update),this.trigger("flicker:finish",t)},change:function(){if(this.flicker_frame==this.flicker_frames.length){if(!(-1==this.flicker_loops||--this.flicker_loops>=1))return this.flicker_stop(),void 0;this.flicker_frame=0}this.flicker_run()},run:function(){var t=this.flicker_frame,e=this.flicker_frames,i=this.flicker_loops,s=e[t],r=this.flick(s,t,e,i);this.trigger("flicker:update",s,t,e,i),r===!1&&this.flicker(),this.flicker_frame++},update:function(t){this.timestep(t,this.flicker_change)}}).defines({flicker:function(t,e,i,s){return!re.is(t)&&this.flickering()?this.flicker_stop():(t>=100&&(t/=1e3),this.flicker_duration=t||1,e=re.is(e,"array")?e:[e],this.flicker_loops=i||1,this.stepProgress=0,this.stepSize=t/e.length/re.loop().second,this.flicker_frames=e,this.flicker_frame=0,this.flickering()||this.on("update",this.flicker_update),this.flicker_id=s||!0,this.trigger("flicker:start"),this)},flickering:function(t){return t?this.flicker_id==t:this.flicker_id}}),re.c("pathfind").method(function(){var t=re.e("pathfind"),e=t.pathfind.apply(t,arguments);return t.dispose(),e}).defines({pathfind_max:50,pathfind:function(t,e,i,s,r,n){this.targetX=i,this.targetY=s,this.onCheck=r,this.onTile=n,this.visit={},this.nodes=[],this.addNode(t,e,-1,-1);for(var o,h=0;this.nodes.length;){if(o=this.nodes.shift(),o.x==this.targetX&&o.y==this.targetY)return this.makePath(o);if(this.searchNodes(o.x,o.y,o.px,o.py),++h>=this.pathfind_max)return null}return null},searchNodes:function(t,e){this.addNode(t+1,e,t,e),this.addNode(t-1,e,t,e),this.addNode(t,e+1,t,e),this.addNode(t,e-1,t,e)},checkNode:function(){return!0},makePath:function(t){var e=[],i=0;do e[i++]=t.x,e[i++]=t.y,t=this.nodes[t.px+"_"+t.py];while(t&&-1!=t.px);return e},addNode:function(t,e,i,s){if(!this.checkNode(t,e,i,s)||this.onCheck&&!this.onCheck(t,e,i,s))return!1;var r=t+"_"+e,n=re.distance(t,e,this.targetX,this.targetY);if(!this.nodes[r]||this.nodes[r].cost>n){for(var o=this.nodes[r]={x:t,y:e,cost:n,px:i,py:s},h=!1,a=0,u=this.nodes.length;u>a;a++)if(this.nodes[a].cost>n){this.nodes.splice(a,0,o),h=!0;break}return h||this.nodes.push(o),this.onTile&&this.onTile(t,e,i,s,n),!0}}}),re.c("timestep").defaults({stepProgress:0,stepSize:100}).defines({timestep:function(t,e,i){for(this.stepProgress+=t;this.stepProgress>=this.stepSize&&(e.call(i||this),this.stepProgress-=this.stepSize,this.stepSize););}}),re.s("render").defines({process:function(t){(!t.visible||t.visible())&&t.draw&&(this.begin(t,this.context),t.draw(this.context),this.end(t,this.context))},begin:function(t,e){e.save(),t.alpha-1&&(e.globalAlpha=t.alpha),t.screenable?e.translate(t.screenX(),t.screenY()):e.translate(t.posX,t.posY),t.rotation&&e.rotate(t.rotation*Math.PI/180),(1!=t.scaleX||1!=t.scaleY)&&e.scale(t.scaleX,t.scaleY)},end:function(t,e){e.restore()}}).init(function(t,e){this.context=t,this.entities=e||re.g("render").create()}),re.s("update").defines({process:function(t){t.updatable&&t.trigger("update",this.stepSize)}}).init(function(){this.stepSize=re.loop().stepSize,this.entities=re.g("update").create()}),re.clone=function(t){if(!re.is("object"))return t;if(re.is(t,"array"))return t.slice();var e={};for(var i in t)e[i]=t[i];return e},re.defaults=function(){for(var t in arguments){var e=arguments[t];if(null!=e)return e}},re.c("polyfill").defines({requestAnimationFrame:function(t,e){return requestAnimFrame(t,e)}}).run(function(){requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}),re.c("scene").statics({_scenes:{}}).method(function(t){var e=re.scene;return re.is(t)?(e._scenes[t]||(e._scenes[t]=re.e("scene").attr("sceneName",t)),e._scenes[t]):e._scenes[re.scene.current]}).defines({enter:function(t){return re.is(t,"function")?this.scene_enter=t:(re.scene.current&&re.scene().exit(),re.scene.current=this.sceneName,this.scene_enter&&this.scene_enter.apply(this,arguments)),this},exit:function(t){return re.is(t,"function")?this.scene_exit=t:(re.scene.current="",this.scene_exit&&this.scene_exit.apply(this,arguments)),this}}),re.sheet=function(t,e,i,s){var r=i||re.tile.sizeX,n=s||re.tile.sizeY;re.is(e,"array")&&(e=e.join(" "));var o,h,a=[];for(var u in t)o=t[u][0]||0,h=t[u][1]||0,a.push(u),re.c(u).requires("sprite "+e).defines({frameX:o,frameY:h,sizeX:r,sizeY:n});return a},function(){re.support=function(t){if(arguments.length>1){for(var e,i=0;arguments.length>i;i++)if(e=arguments[i],re.support(e))return e;return!1}var s=t.split(" "),r=!0;for(var n in s)r=r&&!!re.support[s[n]];return r};var t=re.support;t.canvas=!!document.createElement("canvas").getContext,t.text=!(!t.canvas||"function"!=typeof document.createElement("canvas").getContext("2d").fillText);var e=document.createElement("audio");try{if(t.audio=!!e.canPlayType){t.ogg=e.canPlayType('audio/ogg; codecs="vorbis"'),t.wav=e.canPlayType('audio/wav; codecs="1"'),t.webma=e.canPlayType('audio/webm; codecs="vorbis"'),t.mp3=e.canPlayType('audio/mpeg; codecs="mp3"'),t.m4a=e.canPlayType("audio/mp4; codecs=mp4a.40.2");for(var i in t)("no"==t[i]||""==t[i])&&(t[i]=!1)}}catch(s){}try{t.localstorage=!!localStorage.getItem}catch(s){t.localstorage=!1}t.worker=!!window.Worker,t.webgl=!!window.WebGLRenderingContext,t.touch="ontouchstart"in window}();